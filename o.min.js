!function(e,n){"function"==typeof define&&define.amd?define(["q"],n):"object"==typeof exports?module.exports=n(require("q")):e.o=n(e.Q)}(this,function(e){function n(e){function n(){for(var e,n={},t=0,r=arguments.length;r>t;t++)for(e in arguments[t])arguments[t].hasOwnProperty(e)&&(n[e]=arguments[t][e]);return n}var r=this;return r.oConfig=r.oConfig||{endpoint:null,format:"json",autoFormat:!0,version:4,strictMode:!0,start:null,ready:null,error:null,headers:[],username:null,password:null,isAsync:!0,isCors:!0,openAjaxRequests:0,isHashRoute:!0,appending:""},r.config=function(e){r.oConfig=n(r.oConfig,e)},r.isEndpoint=function(){return null!==r.oConfig.endpoint},"undefined"==typeof e?r:new t(e,r.oConfig)}function t(n,t){function r(){if("undefined"!=typeof e){var n=e;return n}if("undefined"==typeof window){var n=require("q");return n}return null}function o(e,n,t,r){if(A(n)){var o="",a=[];for(i=0;i<n.length;++i)a[i]="("+e+" "+t+" "+n[i][e]+")";return o=a.join(" "+r+" ")}return""}function a(e,n,t){t=t||(4==B.oConfig.version?"contains":"substringof");for(var r=n.split(" "),o="contains"===t||"substringof"===t,a=[],i=0;i<e.length;i++){var u=[];if(o)for(var s=0;s<r.length;s++)4==B.oConfig.version?u.push(t+"("+e[i]+",'"+r[s]+"')"):u.push(t+"('"+r[s]+"',"+e[i]+")");else u.push(e[i]+" "+t+" '"+n+"'");a.push("("+u.join(" and ")+")")}return a.join("or")}function u(e){var n=e||U;n&&0!==n.path.length||k('No resource defined. Define a resource first with o("YourResourcePath").');var t="";I&&(t=B.oConfig.endpoint+(R(B.oConfig.endpoint,"/")?"":"/"));for(var r=0;r<n.path.length;r++)t+=n.path[r].resource,n.path[r].get&&(t+="("+(W[n.path[r].get]||n.path[r].get)+")"),t+="/";return n.appending||(t=t.slice(0,-1)),t+n.appending+s()}function s(){var e="";for(queryName in U.query)U.query.hasOwnProperty(queryName)&&null!=U.query[queryName]&&(e+="&"+U.queryList[U.query[queryName]].name+"="+J(U.queryList[U.query[queryName]].value,W));return e.length>0?"?"+e.substring(1):""}function f(e){for(var n=0;n<M.length;n++)if(M[n].route.regex.test(e)){W={};var t={},r=M[n].route.regex.exec(e);if("undefined"!=typeof M[n].route.param){var o=1;for(prop in M[n].route.param)W[prop]=r[o],t[prop.substring(1)]=r[o],o++}else for(var o=1;o<r.length;o++)W[":"+(o-1)]=r[o],t[o-1]=r[o];Q(t)||g(M[n].callback,t),B.param=t}}function p(e){var n=e;if(!(e instanceof RegExp)){B.oConfig.isHashRoute&&!N(e,"#")&&(e="#"+e);for(var t=e.split("/"),r={},o=0;o<t.length;o++)N(t[o],":")&&(r[t[o]]=!0,t[o]="([\\w| |-]+|\\[W| |-]+)");n=new RegExp("^"+t.join("/")+"$")}return{regex:n,param:r}}function l(e){return JSON?JSON.parse(JSON.stringify(e)):void k("No JSON Support.")}function d(e){var n=new RegExp("'.*?'",""),t=n.exec(e);e=e.replace(n,"{0}");for(key in K)e=e.split(key).join(" "+K[key]+" ");if(null!=t)for(var r=0;r<t.length;r++)e=e.replace("{0}",t[r]);return e}function h(e){U&&G.push(U),U="string"==typeof e?m(e):e,!w("$format")&&B.oConfig.autoFormat&&C("$format",B.oConfig.format);for(var n=0;n<B.oConfig.appending.length;n++)C(B.oConfig.appending[n].name,B.oConfig.appending[n].value)}function c(e,n,t,r){if(null===U&&k('You must define a resource to perform a get(), post(), put() or delete() function. Define a resource with o("YourODataResource").'),0!==G.length||t){G.push(U);var o=_(U.method,u());if(P(["POST","PATCH","DELETE","PUT"])<=1&&t&&!z)j(o,b(U.data),e,n,!1,[{name:"Accept",value:"application/json"},{name:"Content-Type",value:"application/json"}],r,G[G.length-1].progress),E(["POST","PATCH","DELETE","PUT"]);else{for(var a=$(),i=B.oConfig.endpoint+(R(B.oConfig.endpoint,"/")?"":"/")+"$batch",s=0;s<B.oConfig.appending.length;s++)i+=(0===s?"?":"&")+B.oConfig.appending[s].name+"="+B.oConfig.appending[s].value;j(_("POST",i),L(a,t),e,n,!0,[{name:"Content-Type",value:"multipart/mixed; boundary=batch_"+a}],r,G[G.length-1].progress),t&&E(["POST","PUT","DELETE"])}}else j(_("GET",u()),null,e,n,!1,[{name:"Accept",value:"application/json,text/plain"},{name:"Content-Type",value:"application/json"}],r,U.progress)}function g(e,n){""!==U.path[0].resource?c(e,null,!1,n):e.call(B,n)}function y(e){return"undefined"==typeof e?B:(e.toUpperCase().indexOf("HTTP://")>-1||e.toUpperCase().indexOf("HTTPS://")>-1?I=!1:B.oConfig.endpoint||k("You can not use resource query without defining your oData endpoint. Use o().config({endpoint:yourEndpoint}) to define your oData endpoint."),routeName=e,h(e),B)}function v(e){w("$expand")?(U.queryList[U.query.$expand].value+=","+e,U.queryList[U.query.$expand].original=U.queryList[U.query.$expand].value):C("$expand",e,e)}function m(e){var n=e.split("?"),t=e,r="",o={path:[],appending:"",query:{},queryList:[],method:"GET",data:null,progress:null};if(2===n.length){t=n[0],r=n[1];for(var a=r.split("&"),i=0;i<a.length;i++){var u=a[i].split("=");o.queryList.push({name:u[0],value:u[1]}),o.query[u[0]]=o.queryList.length-1}}for(var s=t.split("/"),i=0;i<s.length;i++)if(N(s[i],"$")&&"$link"!==s[i])o.appending=s[i];else{var f=s[i].split("(");1===f.length||N(s[i],"(")?o.path.push({resource:s[i],get:null}):o.path.push({resource:f[0],get:f[1].substring(0,f[1].length-1)})}return o}function C(e,n,t,r){t=t||null,U.queryList.push({name:e,value:n,original:t}),U.query[r||e]=U.queryList.length-1}function x(e,n,t,r,o){t=t||null,r=r||" or ",e=o||e,U.queryList[U.query[e]].value="("+U.queryList[U.query[e]].value+")"+r+"("+n+")",t&&(U.queryList[U.query[e]].original=U.queryList[U.query[e]].value)}function q(e){U.query[e]=null}function T(e){if(w(e)){var n=e;return A(n)&&(n=n.join(",")),k("There is already a depending query. You can not use them together/twice: "+n),!0}return!1}function w(e){for(var n=A(e)?e:[e],t=!1,r=0;r<n.length;r++)U.query.hasOwnProperty(n[r])&&(t=!0);return t}function $(){var e=(new Date).getTime(),n="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var t=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==n?t:7&t|8).toString(16)});return n}function S(e,n){return"undefined"!=typeof e&&null!==e&&e.length>0?e:void k(n+": Parameter must be set.")}function O(e,n){if("number"==typeof e)return e;var t=n;return e&&e.length>0&&(isNaN(e)||(t=parseInt(e))),t}function P(e){for(var n=0,t=0;t<G.length;t++)e.indexOf(G[t].method)>-1&&n++;return n}function E(e){for(var n=[],t=0;t<G.length;t++)e.indexOf(G[t].method)>-1&&n.push(t);for(var t=n.length-1;t>=0;t--)G.splice(n[t],1);G[0]&&(U=G[0])}function b(e){return JSON?JSON.stringify(e):(k("No JSON support."),e)}function A(e){return"undefined"==typeof Array.isArray?"[object Array]"===e.toString():Array.isArray(e)}function R(e,n){return e?-1!==e.indexOf(n,e.length-n.length):!1}function N(e,n){return 0===e.indexOf(n)}function k(e){function n(e){this.message=e,this.name="o.js exception"}if(n.prototype=new Error,B.oConfig.strictMode===!0)throw new n(e);console.log("o.js exception: "+e)}function L(e,n){var t="",r=$(),o=!1;n&&(t+="--batch_"+e+"\n",t+="Content-Type: multipart/mixed; boundary=changeset_"+r+"\n\n");var a=null;null!==B.oConfig.endpoint&&(a=B.oConfig.endpoint.indexOf("://")>-1?B.oConfig.endpoint.split("/")[2]:B.oConfig.endpoint.split("/")[0],a=a.split(":")[0]);for(var i=0;i<G.length;i++){var s=G[i];if(U=s,"GET"!==s.method||n){if(("POST"===s.method||"PUT"===s.method||"PATCH"===s.method||"DELETE"===s.method)&&n){t+="--changeset_"+r+"\n",t+="Content-Type: application/http\n",t+="Content-Transfer-Encoding: binary\n",t+="Content-ID:"+i+"1\n\n",t+=s.method+" "+u(s)+" HTTP/1.1\n",t+="Host: "+a+"\n";for(var f=0;f<B.oConfig.headers.length;f++){var p=B.oConfig.headers[f];t+=p.name+": "+p.value+"\n"}t+="Content-Type: application/json\n",t+="\n"+b(U.data)+"\n\n\n",o=!0}}else{t+="--batch_"+e+"\n",t+="Content-Type: application/http\n",t+="Content-Transfer-Encoding: binary\n\n",t+=s.method+" "+u(s)+" HTTP/1.1\n",t+="Host: "+a+"\n";for(var f=0;f<B.oConfig.headers.length;f++){var p=B.oConfig.headers[f];t+=p.name+": "+p.value+"\n"}t+="\n"}}return o&&(t+="--changeset_"+r+"--\n\n"),t+="--batch_"+e+"--"}function j(e,n,t,r,o,a,i,s){B.oConfig.start&&null==F&&(B.oConfig.openAjaxRequests++,B.oConfig.start()),F&&F[0]&&F[0](!0);var f=B;if(z?(e.onload=function(n){e.readyState=4,e.status=200,e.onreadystatechange()},e.onerror=function(n){e.readyState=0,e.status=400,e.onreadystatechange()}):"function"==typeof s&&(e.onprogress=s),e.onreadystatechange=function(){if(4===e.readyState){if(e.status>=200&&e.status<300){if(204!==e.status)if(o){var n,a=[],s=/({[\s\S]*?--batchresponse_)/g;do n=s.exec(e.responseText),n&&(D(n[0].substring(0,n[0].length-16),f),a.push(f.data));while(n);f.data=a}else D(e.responseText,f);X&&X.resolve(f),"function"==typeof t&&t.call(f,f.data,i)}else try{var p=e.responseText;if(JSON&&""!=e.responseText&&(p=JSON.parse(e.responseText)),""!==p&&p["odata.error"]){var l=p["odata.error"].message.value+" | HTTP Status: "+e.status+" | oData Code: "+p["odata.error"].code;k(l)}else k("Request to "+u()+" failed with HTTP status "+(e.status||404)+".")}catch(d){if(H(f,!0,e.status||404,e.responseText),"function"==typeof r)r(e.status||404,d);else{if(!X)throw d;d.status=e.status||404,X.reject(d)}}H(f,!1)}},B.oConfig.username&&B.oConfig.password&&(z&&k("CORS and Basic Auth is not supported for IE <= 9. Try to set isCors:false in the OData config if you do not need CORS support."),e.setRequestHeader("Authorization","Basic "+Y(B.oConfig.username+":"+B.oConfig.password))),!z){if(a)for(var p=0;p<a.length;p++)e.setRequestHeader(a[p].name,a[p].value);if(B.oConfig.headers.length>0)for(var p=0;p<B.oConfig.headers.length;p++)e.setRequestHeader(B.oConfig.headers[p].name,B.oConfig.headers[p].value)}e.send(n)}function H(e,n,t,r){e.oConfig.ready&&null==F&&(e.oConfig.openAjaxRequests--,e.oConfig.openAjaxRequests<=0&&e.oConfig.ready()),F&&F[1]&&F[1](!1),e.oConfig.error&&n&&e.oConfig.error(t,r)}function D(e,n){var t=O(e,-1);if(-1!==t)n.data=t;else if(JSON&&""!==e){var r=JSON.parse(e);n.raw=r,r.hasOwnProperty("value")?(w(["$first"])&&r.value.length&&r.value.length<=1?n.data=r.value[0]:n.data=r.value,(r.hasOwnProperty("odata.count")||r.hasOwnProperty("@odata.count"))&&(n.inlinecount=r["odata.count"]||r["@odata.count"])):n.data=r,U.data=n.data}else n.data=e}function _(e,n){var t=null;if("undefined"==typeof window){var r=require("xhr2");t=new r}else t=new XMLHttpRequest;return B.oConfig.isCors&&"withCredentials"in t?(t.withCredentials=!0,t.open(e,n,B.oConfig.isAsync)):B.oConfig.isCors&&"undefined"!=typeof XDomainRequest?(t=new XDomainRequest,z=!0,"GET"==e?t.open(e,n):t.open("POST",n)):t.open(e,n,B.oConfig.isAsync),t}function J(){var e=arguments[0],n=arguments[1];for(var t in n){var r=new RegExp(t,"g");"string"==typeof e&&(e=e.replace(r,n[t]))}return e}function Y(e){var n={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t,r,o,a,i,u,s,f="",p=0;for(e=n._utf8_encode(e);p<e.length;)t=e.charCodeAt(p++),r=e.charCodeAt(p++),o=e.charCodeAt(p++),a=t>>2,i=(3&t)<<4|r>>4,u=(15&r)<<2|o>>6,s=63&o,isNaN(r)?u=s=64:isNaN(o)&&(s=64),f=f+this._keyStr.charAt(a)+this._keyStr.charAt(i)+this._keyStr.charAt(u)+this._keyStr.charAt(s);return f},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");for(var n="",t=0;t<e.length;t++){var r=e.charCodeAt(t);128>r?n+=String.fromCharCode(r):r>127&&2048>r?(n+=String.fromCharCode(r>>6|192),n+=String.fromCharCode(63&r|128)):(n+=String.fromCharCode(r>>12|224),n+=String.fromCharCode(r>>6&63|128),n+=String.fromCharCode(63&r|128))}return n}};return n.encode(e)}var B=this,U=null,G=[],M=[],I=!0,X=null,F=null,z=!1,Q=function(){},W={},K={"==":"eq","===":"eq","!=":"ne","!==":"ne",">":"gt",">=":"ge","<":"lt","<=":"le","&&":"and","||":"or","!":"not","*":"mul","%":"mod"};return B.data=[],B.inlinecount=null,B.param={},B.oConfig=t,B.raw=null,B.routes=B.route=function(e,n){A(e)||(e=[e]),"undefined"==typeof window&&k("Routes are only supported in a browser env.");for(var t=window.location.hash,r=0;r<e.length;r++)"undefined"!=typeof n?M.push({name:e[r],route:p(e[r]),callback:n,param:{},interval:setInterval(function(){window.location.hash!=t&&(t=window.location.hash,f(window.location.hash))},100)}):k('Routes without a callback are not supported. Please define a function like .route("YourRoute", function() { }).');return B.triggerRoute(window.location.hash),B},B.beforeRouting=function(e){return Q=e,B},B.isEndpoint=function(){return I},B.triggerRoute=function(e){return f(e),B},B.find=function(e){return U.path[U.path.length-1].get=e,B},B.top=B.take=function(e){return T(["$top"])||C("$top",e,e),B},B.skip=function(e){return T("$skip")||C("$skip",e,e),B},B.first=function(){return T(["$top","$first"])||C("$top",1,null,"$first"),B},B.filter=B.where=function(e){var n=S(d(e));return w("$filter")?x("$filter",n,n):C("$filter",n,n),B},B.any=function(e,n){var t=e+"/any(x:x/"+d(S(n))+")";return w("$filter")?x("$filter",t,t):C("$filter",t,t),B},B.orderBy=function(e,n){return"undefined"==typeof n&&(n="asc"),T("$orderby")||C("$orderby",S(e)+" "+n),B},B.orderByDesc=function(e){return B.orderBy(e,"desc")},B.select=function(e){return C("$select",S(e)),B},B.count=function(){return B.oConfig.version>=4?U.path.push({resource:"$count",get:null}):(q("$format"),C("$count","count")),B},B.inlineCount=function(e){return B.oConfig.version>=4?(e=e||"true",T("$count")||C("$count",e)):(e=e||"allpages",T("$inlinecount")||C("$inlinecount",e)),B},B.batch=function(e){return h(e),B},B.expand=function(e){return v(e),B},B.loading=function(e,n){return n=n||e,F=e?[e,n]:[function(){},function(){}],B},B.ref=B.link=function(e,n){q("$format"),(null==U||U.get)&&k("You need to define a resource with the find() method to append an navigation property"),B.oConfig.version<4?(U.method="POST",U.path.push("$link"),U.path.push({resource:e,get:null})):(U.method="POST",U.path.push({resource:e,get:null}),U.path.push({resource:"$ref",get:null}));var t=m(e);t.path[t.path.length-1].get=n;var r=u(t);return U.data={"@odata.id":r.substring(0,r.length-1)},B},B.removeRef=B.deleteRef=function(e,n){if(q("$format"),(null==U||U.get)&&k("You need to define a resource with the find() method to append an navigation property"),B.oConfig.version<4?(U.method="POST",U.path.push("$link"),U.path.push({resource:e,get:null})):(U.method="POST",U.path.push({resource:e,get:null}),U.path.push({resource:"$ref",get:null})),n){var t=m(e);t.path[t.path.length-1].get=n;var r=u(t);C("$id",r.substring(0,r.length-1))}return U.method="DELETE",B},B.get=function(e,n){var t=r();return t&&"undefined"==typeof e&&(X=t.defer()),c(e,n,!1),t&&"undefined"==typeof e?X.promise:B},B.save=function(e,n){if("GET"===U.method&&null!==U.data){var t=l(U);t.method="PATCH",t.data=U.data,h(t)}var o=r();return o&&"undefined"==typeof e?(X=o.defer(),c(e,n,!0),X.promise):(c(e,n,!0),B)},B.post=function(e,n){return q("$format"),n&&h(n),U.method="POST",U.data=e,B},B.patch=function(e,n){return n&&h(n),U.path[U.path.length-1]&&U.path[U.path.length-1].get||k("Bulk updates are not supported. You need to query a unique resource with find() to patch/put it."),U.method="PATCH",U.data=e,B},B.put=function(e,n){return n&&h(n),U.path[U.path.length-1]&&U.path[U.path.length-1].get||k("Bulk updates are not supported. You need to query a unique resource with find() to patch/put it."),U.method="PUT",U.data=e,B},B.remove=B["delete"]=function(e){return e&&h(e),U.path[U.path.length-1]&&U.path[U.path.length-1].get||k("Bulk deletes are not supported. You need to query a unique resource with find() to delete it."),U.method="DELETE",B},B.query=function(e){return u(e)},B.search=function(e,n,t,r){var o=a(e,n,t);return 4==B.oConfig.version&&r?T("$search")||C("$search",o,o):T("$filter")||C("$filter",o,o,"$search"),B},B.filterByList=B.exclude=function(e,n){if(!T("$filter")){var t=o(e,n,K["!="],K["&&"]);C("$filter",S(t),t)}return B},B.include=function(e,n){if(!T("$filter")){var t=o(e,n,K["=="],K["||"]);C("$filter",S(t),t)}return B},B.progress=function(e){return null!=U&&(U.progress=e),B},y(n)}return n});